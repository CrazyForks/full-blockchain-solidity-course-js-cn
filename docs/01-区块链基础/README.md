# 区块链基础

区块链和智能合约的基础理论很重要，它们将指导你如何架构你的去中心化应用。

## 什么是区块链

比特币是最早使用区块链技术的协议之一。

比特币的[白皮书](https://en.wikipedia.org/wiki/White_paper)是由一个叫做[Satoshi Nakamoto](https://en.wikipedia.org/wiki/Satoshi_Nakamoto)的匿名人士撰写的。它描述了如何在一个去中心化网络中进行 P2P 交易。这个网络以密码学算法为基础，能够让人们以去中心化的方式，进行非许可的金融行为。

因为这些特点，比特币被认为是一种高级的电子价值存储，类似于黄金的价值存储。这也是为什么人们将其称为"电子黄金"的原因。像黄金一样，比特币的总量也是有上限的，人们只能交易固定数量的比特币。你可以阅读比特币白皮书，以了解它的最初版本。这是一项伟大的突破，现在我们要学习这些技术的原理，以及它是如何运行的。

### 以太坊的诞生

在比特币之后，[Vitalik Buterin](https://en.wikipedia.org/wiki/Vitalik_Buterin) 提出了一个更具创新性的协议 —— [以太坊](https://en.wikipedia.org/wiki/Ethereum)。以太坊不仅继承了比特币的区块链技术，还引入了革命性的新功能：

- 去中心化交易
- 智能合约
- 去中心化自治组织（DAO）
- 无需中介的协作机制

2015年，Vitalik 与几位联合创始人共同发布了以太坊。这个平台的核心创新在于将比特币的技术与智能合约相结合，为去中心化应用提供了完整的解决方案。

### 智能合约的起源

智能合约的概念并非以太坊首创。早在 1994 年，计算机科学家 [Nick Szabo](https://en.wikipedia.org/wiki/Nick_Szabo) 就首次提出了智能合约的概念。他的愿景是使用计算机协议来执行、验证或强制执行合同条款，从而减少对可信中介的需求。

## 智能合约（Solidity）

智能合约是通过去中心化的方式来执行一系列指令，在这些指令执行过程中，并不需要中心化或第三方的中介。区块链及以太坊实现了智能合约的概念。智能合约也是本套课程的核心，我们要开发的就是智能合约。

你可以把智能合约理解为传统的契约和合同。智能合约同样是约定多个参与方的一系列指令。不同的是：

- 传统的合同是通过笔写在纸上，或者通过 Word 将内容输入进去
- 智能合约则是通过代码，嵌入到一个去中心化区块链平台
- 智能合约在这个去中心化区块链平台中被执行，而不是被第二、第三或更多参与方去执行

因此，智能合约解决了中心化带来的问题。

## 以太坊与比特币的区别

以太坊和比特币最大的不同点就是智能合约。从技术上讲，比特币确实有智能合约，但比特币不是图灵完备的，这意味着比特币不能执行编程语言的所有指令。比特币开发者主要将比特币定位为价值存储，而以太坊开发者除了将以太坊视为价值存储外，还将其定位为一个运行去中心化合约的平台。

## 预言机问题

尽管区块链和智能合约技术非常强大，但它们也带来了一个重要挑战：预言机问题。如果我们想用智能合约替代日常使用的合同，它们就需要真实世界的数据输入。然而，区块链本身无法获取真实世界的信息。

区块链网络都是确定性系统，它们会根据预设的规则进行验证。我们将在后续课程中详细学习这些网络的运行机制。

### 预言机的作用

智能合约能够获取区块链上的所有信息，但要作为日常合同使用，它们需要：
- 外部数据输入
- 外部计算能力

这就是预言机的作用。预言机是任何可以向区块链输入数据或进行链下计算的设备。然而，要实现真正的去中心化，我们不能仅依赖：
- 单个预言机
- 单个数据提供商
- 单个计算资源

我们需要一个去中心化的预言机网络，就像去中心化的区块链网络一样。

## 混合型智能合约

### 概念

混合型智能合约结合了：
- 链上去中心化逻辑
- 链下去中心化数据和计算

目前大多数流行的协议都是某种类型的混合型智能合约，或在某种程度上与混合型智能合约交互。

### Chainlink 的作用

Chainlink 是一个组件化、去中心化的预言机网络，它为混合型智能合约提供：
- 外部数据接入
- 链下计算能力
- 合约自动化执行
- 随机数生成
- 自定义智能合约功能

通过 Chainlink，混合型智能合约可以在链上和链下都保持去中心化，使其能够像日常合同一样实用。

Chainlink 是当下最流行和最强大的去中心化预言机网络。Chainlink 对所有区块链都是中立的，它和以太坊、Avalanche、Polygon、Solana、Terra 及很多区块链都有集成。

## 多链生态与术语说明

### 主流智能合约平台

在混合型智能合约出现以后，很多智能合约平台都对此做了支持，包括 Avalanche、Polygon、Fantom、Harmony 等。在本课程中，我们将会假设我们是用以太坊来部署智能合约，但课程内容对大多数区块链网络都适用。

### 跨链开发

学习以太坊基础之后，你会有能力在不同的链上开发应用，只需要改动一行代码就可以适配其他链，非常简单。不需要担心不了解某些链或某些工具，因为它们大部分都可以互通。尽管有一些智能合约平台不使用 Solidity，但是通过学习 Solidity，也会让你更好地理解和使用它们。目前以太坊还是沉淀了最多的价值，也是被使用的最多的智能合约平台。

### 常用术语

在本课程中，你会经常遇到以下术语，它们通常指代相同概念：
- DApp（去中心化应用）
- 去中心化协议
- 智能合约应用
- 去中心化应用

这些应用通常由多个智能合约组成。你常会听到"智能合约平台"和"区块链"这两个名称经常被无差别使用，它们在本课程中指的是同一个概念。

## Web3 概述

Web3 是一种观点，指的是以区块链和智能合约为基础的下一代的网络。Web 的发展历程如下：

- **Web1**：固定的非许可开源网络
- **Web2**：动态内容的许可网络，你所有的逻辑和协议运行在中心化的服务器上，这些中心化服务器控制着你的信息
- **Web3**：非许可网络，但承载动态内容，相对于中心化服务器，去中心化网络运行着你的逻辑

智能合约可以允许你创建无需审核的合同和逻辑。在 Web3 中，通常伴随着一个概念，即用户拥有他们所使用的协议，也就是拥有者经济。

## 智能合约的价值

我认为，只有能够解决问题的技术，才是好的技术。如果一个技术什么问题都不解决，那我们没有必要了解。智能合约、区块链、Web3、加密货币这些不同的词，都代表着我们在新的范式下所做的东西。

智能合约的核心价值在于：
- 创建信任最小化协议
- 创建不可违背的承诺
- 提升性能、透明度和可访问性

## 智能合约的作用

现实中，协议和合约最大的问题就是我们不得不相信履行合约的人，会按照合约内容办事。然而，通常不按内容履行，他们收益更多。使用智能合约，现在我们终于有一种方法来解决这个问题。

智能合约简单来说，就是部署在去中心化区块链上的一个合约或者一组指令，当这个合约或这组指令被部署以后，它就不能被改变了。它会自动执行，每个人都可以看到合约中的条款。更深层次的理解是，这些代码会被去中心化地执行。

就像一群人运行了某个软件，这就意味着没有一个人或者一个主体，可以修改这些合约或者更改条款。特别是当智能合约部署在去中心化的区块链上，同时结合另一个去中心化的预言机网络，获取真实世界的资产和信息。

信任最小化合约，不可违背的承诺。区块链、智能合约和加密货币，能做的事情，不仅限于最小化合约，它们更加安全，更容易被监控，执行速度更快等。

## 区块链的优势

### 基础价值

现在，像是比特币和以太坊这样的加密货币，即使没有智能合约部分，也是有价值的。它们可以抗审核、去中心化的存储价值，这个功能已经非常强大了。

### 相对于传统金融的优势

1. **去中心化**
   - 没有中心化的中介
   - 一个链上由不同的参与者运行
   - 这些参与者被称为节点运营者
   - 成千上万的节点运营者运行同一个软件，运行这些算法，运行智能合约
   - 这才使得网络是去中心化的

2. **透明性和灵活性**
   - 所有的节点运营者都运行这个软件
   - 每个人可以看到链上发生的任何事情
   - 这意味着没有内幕交易，不会有离奇的事情发生
   - 任何不公平的事情，人们都会看到，并且不会使用它
   - 每个人获得的信息是一致的，并且在统一规则下协作
   - 不过，这不等同于没有隐私，区块链是匿名的，意味着你不需要绑定实际生活中的身份

3. **速度和效率**
   - 交易会实时发生
   - 并不需要清结算
   - 交易即结算
   - 这个方式更快，而且让人与人之间的协作更有效率

4. **安全和不可更改**
   - 一旦智能合约被部署，它就不能被改变了
   - 不管代码是什么样的，它就永远会是这样了
   - 通过任何方式，它们都不能被篡改
   - 这意味着更容易做到安全

5. **移除信任准入机制**
   - 当我们与其他人协作和交互时，我们的利益不是他们最关心的
   - 智能合约避免了交易对手风险
   - 因为一旦智能合约被创建出来，他们不能再去修改它
   - 他们不能按照自己的意愿随意修改合约的内容来获利

6. **信任最小化合约**
   - 以数学为基础的协议
   - 我们可以看到密码学证明，也可以查看代码
   - 了解到底会发生什么，指令会如何执行
   - 而不是依赖一个人去做符合规则的事
   - 任何基于智能合约和去中心化混合智能合约的操作，都是基于规则的

## 智能合约应用场景

### DeFi（去中心化金融）

DeFi 代表去中心化金融。它让用户可以参与到金融市场，而不需要经过中心化中介。你可以直接查看智能合约，接入市场。

### DAO（去中心化自治组织）

DAO，即去中心化自治组织。DAO 是完全被去中心化管理的组织。它们被区块链上的一组指令或者一个智能合约管理。

### NFT（非同质化代币）

NFT 代表"非同质化代币"，它在某种程度上是一种电子艺术品，或者一个独一无二的资产。

## 第一笔交易

### 准备工作
- [以太坊网站](https://ethereum.org/zh/)
- [MetaMask](https://metamask.io/)

### 账户安全
助记词可以管理你的多个账户，私钥只可以管理一个账号。
这就是人们常说的要保证你的私钥安全。拥有私钥，才拥有比特币和以太坊这些资产。

### 测试网络

#### 三大测试网对比

| **测试网**       | **定位**                | **性能特点**         | **适用场景**               | **代币经济**          |
|------------------|------------------------|---------------------|--------------------------|----------------------|
| **Sepolia**      | 以太坊官方 dApp 测试网   | 中规中矩，贴近主网    | 智能合约基础测试           | sepETH 无限供应       |
| **Linea Sepolia**| zkEVM Layer2 生态测试网 | 高压缩比，低成本      | DeFi、跨链应用开发         | 依赖 Sepolia 测试币   |
| **Mega Testnet** | 超高性能 Layer2 测试网   | 10万 TPS + 亚毫秒延迟 | 高频交易/实时应用（如游戏） | 无公开代币，技术验证   |

#### 测试币获取
- [Alchemy Faucet (Amoy)](https://sepoliafaucet.com)
- [Faucets](https://faucets.chain.link/sepolia)

## Gas 费用机制

### 基本概念
不同的节点运行区块链，是因为它们可以通过区块链上的交易获得收入。当你创建一个交易的时候，就会有一个节点，或者叫做矿工和验证者，某个运行区块链软件的人。他们会被支付一小部分，Polygon 或者其他区块链的原生代币。
这些收入也会激励人们运行节点，他们的收入是由 gas 使用量来决定的，这是 gas 的概念。

### 费用特点
Gas 是一个计算量的单位，要使用很多的计算资源，就需要支付更多的 gas。对于发送以太币这样简单的交易，gas 会比较便宜。对于像是铸造 NFT，或者向某个 DeFI 存钱这种复杂的交易，可能就会花费更多的 gas，因为会用到更多的计算。

## 区块链核心机制

[区块链示例](https://andersbrownworth.com/blockchain/blockchain)

### Hash 哈希
哈希是一个独一无二的固定长度的字符串，用来代表一段数据。它是通过将一个数据传入"哈希函数"来生成的。以太坊也使用哈希算法。

> 以太坊使用的是 Keccak256，演示中使用 SHA256，不过并不影响理解。
> 哈希算法是一个函数，它可以计算一段数据，生成一个独一无二的哈希值。

### Block 区块
在区块中，我们把数据分成，块高、Nonce和Data三部分，然后对其进行哈希运算，得到哈希值。

矿工要解决的问题是，他们需要找一个 Nonce，或着说一个数值，找到的 Nonce 需要和块高以及 Data 一起进行哈希运算，结果必须要以4个0开始。矿工要解决的问题就是，找到以4和0开头的哈希值。他们唯一的解决方法就是一个一个尝试。

虽然每个区块链要解决的具体"难题"不同，以太坊的矿工要解决另一个"难题"，比特币网络要解决"难题"也不同，但是它们概念都是一样的。它们会通过使用一个区块的内容，这些内容包括 Data 部分，块高部分和Nonce。Nonce是答案，它是一个数字来解决这个"难题"。这就是区块链矿工的挖矿过程。就是一个不断计算的过程来找到Nonce，而这个Nonce可以解决对应的"难题"。

**挖矿是找到区块链"难题"的"答案"的过程。**

上面的例子中，这个"难题"是找一个以4个0开始的哈希值。节点通过挖矿来获得收入，同时不同区块要解决的"难题"也不同。

### Blockchain 区块链
区块里有块高、Nonce、Data，现在除了它们，还有一个Prev，Prev会指向上一个区块的哈希值。

Prev 全是 0 的区块，被称为创世区块，是区块链中的第一个区块。创世区块的 Prev 会指向一个并不存在的区块。

在区块链中，是将块高、Nonce、Data、Prev 一起计算，然后得到哈希值。类似默克尔树。

> 默克尔树（Merkle Tree）是一种基于哈希函数的树形数据结构，用于高效验证大规模数据的完整性和一致性。其核心原理是将数据分块哈希后逐级组合生成根哈希值（Merkle Root），任何底层数据的修改都会导致根哈希值变化，从而快速检测篡改。

如果改变中间区块的 Data 值，整个区块链都会无效，因为没有一个区块里的Nonce能够生成正确的哈希值，解决"难题"。这就是区块链不可篡改的原因，因为你一改动任何一个数据，会让后面的区块都无效。这很合理，因为区块链的历史数据很难被篡改。所以如果想要修改，那必须重新挖矿。

区块链的区块由块高、Nonce、交易和前一个区块哈希值组成。这个区块的唯一哈希，可以通过这些数据创建出来。当然，由于区块链的实现方式不同，这里可能存在不同的信息。

### Distributed 分布式
分布式区块链和之前的区块链完全一样，但是多了一个东西，Peer。例如 Peer A、Peer B、Peer C。很多人提到的 P2P 或者 P2P 交易，就是指这里的 Peer 的概念。不同的 Peer，都在运行这个区块链，它们的权重相同。区块链的每一个 Peer，节点或者是运营主体，都有着相同的权力。决定哪条链才是正确的方法非常简单，就是看最后一个区块的哈希值。通过它来确定整个区块链的信息。最后一个区块的哈希值，包含前面所有的区块的信息，这个区块的 Prev 指向上个区块的哈希值，上个区块的 Prev 又指向它的上个区块，循环往复。所以最后一个哈希包含了所有内容。

所有的节点，运行区块链软件的不同用户，数据都是一致的。节点可以很容易地检查其他节点的哈希，然后确定数据都是一样的。

区块链是去中心化的，或者说是分布式的，因为很多不同的用户在运行这个区块链软件，它们会彼此检查和比对，哪些是诚实节点，那些是恶意节点。

### Tokens 代币
之前的例子 Data 还没有意义，这个例子中没有了 Data 部分，引入 Tx 部分（交易部分）替代它。

Tx 部分代表这个区块中发生的所有交易。这些交易会像之前的 Data 一样进行哈希运算，这个特性很强大，如果我们想恶意修改数据，整个区块链都会无效，因为这是一个时间很久的交易。这就是区块链底层的运作原理。所有都是基于这个哈希算法，然后通过复杂的方式生成密码学证明，这些密码学证明是其他操作的基础。

区块链其实是通过 Solidity 代码运行的，而非将随机值放在 Data 区域。Solidity 代码定义了链上不同区块和协议交互方式，它们是通过智能合约定义的。

在这个例子中，Nonce 指的是用来解决 "难题" 的数字，可以生成 4个0开头的哈希值。

### Coinbase 币基

